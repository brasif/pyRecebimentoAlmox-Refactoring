{% extends "base.html" %}

{% set title = "Todos os Registros" %}

{% block content %}
<section>

    <h1>Todos os Registros</h1>

    <!-- Seção para exibir mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">×</span>
        </button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="table-responsive">
        <table>
            <form method="GET" action="{{ url_for('tabela.tabela_todos_registros') }}" id="filter-form">
                <thead>
                    <tr>
                        <th>Mês</th>
                        <th>Data recebimento</th>
                        <th>
                            <input type="text" class="form-control" name="chave_acesso" 
                                   value="{{ request.args.get('chave_acesso') or '' }}" placeholder="Chave de Acesso"
                                   onchange="document.getElementById('filter-form').submit()">
                        </th>
                        <th>
                            <input type="text" class="form-control" name="nota_fiscal" 
                                   value="{{ request.args.get('nota_fiscal') or '' }}" placeholder="Nota Fiscal"
                                   onchange="document.getElementById('filter-form').submit()">
                        </th>
                        <th>
                            <select class="form-control" id="filial" name="filial"
                                onchange="document.getElementById('filter-form').submit()">
                                <option value="">Filial</option>
                                {% for f in Filiais %}
                                <option value="{{ f.name }}"
                                    {% if request.args.get('filial') == f.name %}selected{% endif %}>{{ f.value }}
                                </option>
                                {% endfor %}
                            </select>
                        </th>
                        <th>
                            <input type="text" class="form-control" name="centro" 
                                   value="{{ request.args.get('centro') or '' }}" placeholder="Centro"
                                   onchange="document.getElementById('filter-form').submit()">
                        </th>
                        <th>
                            <input type="text" class="form-control" name="status" 
                                   value="{{ request.args.get('status') or '' }}" placeholder="Status"
                                   onchange="document.getElementById('filter-form').submit()">
                        </th>
                        <th>Data guarda</th>
                        <th>
                            <select class="form-control" name="prioridade" 
                                    onchange="document.getElementById('filter-form').submit()">
                                <option value="">Prioridade</option>
                                <option value="true" {% if request.args.get('prioridade') == 'true' %}selected{% endif %}>Sim</option>
                                <option value="false" {% if request.args.get('prioridade') == 'false' %}selected{% endif %}>Não</option>
                            </select>
                        </th>
                        <th>
                            <input type="text" class="form-control" name="responsavel" 
                                   value="{{ request.args.get('responsavel') or '' }}" placeholder="Resp. Atualização"
                                   onchange="document.getElementById('filter-form').submit()">
                        </th>
                    </tr>
                </thead>
            </form>
            <tbody>
                {% for registro in registros.items %}
                <tr>
                    <td>{{ registro.mes|title }}</td>
                    <td>{{ registro.data_recebimento.strftime('%d/%m/%Y %H:%M h') }}</td>
                    <td class="descricao">
                        <a href="{{ url_for('visualizacao.visualizar_nota_fiscal', id_nota_fiscal=registro.nota_fiscal.id_nota_fiscal) }}">
                            {{ registro.nota_fiscal.chave_acesso }}
                        </a>
                    </td>
                    <td style="min-width: 8rem;">{{ registro.nota_fiscal.numero_nf }}</td>
                    <td>{{ registro.nota_fiscal.filial.value|title }}</td>
                    <td style="min-width: 6rem;">{{ registro.nota_fiscal.nome_centro }}</td>
                    <td>{{ registro.status_registro }}</td>
                    <td>
                        {% if registro.data_guarda %}
                        {{ registro.data_guarda.strftime('%d/%m/%Y') }}
                        {% endif %}
                    </td>
                    <td style="min-width: 9rem;">{{ 'Sim' if registro.nota_fiscal.prioridade else 'Não' }}</td>
                    <td>
                        <a href="{{ url_for('visualizacao.visualizar_responsavel', id_responsavel=registro.responsavel.id_responsavel) }}">
                            {{ registro.responsavel.nome_responsavel }}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            {% if registros.has_prev %}
            <li class="page-item"><a class="page-link" href="{{ url_for('tabela.tabela_todos_registros', page=registros.prev_num, 
                chave_acesso=request.args.get('chave_acesso'), 
                nota_fiscal=request.args.get('nota_fiscal'), 
                filial=request.args.get('filial'), 
                centro=request.args.get('centro'), 
                status=request.args.get('status'), 
                prioridade=request.args.get('prioridade'), 
                responsavel=request.args.get('responsavel')) }}">Anterior</a></li>
            {% endif %}
            <li class="page-item disabled"><a class="page-link" href="">Página {{ registros.page }} de {{ registros.pages }}</a></li>
            {% if registros.has_next %}
            <li class="page-item"><a class="page-link" href="{{ url_for('tabela.tabela_todos_registros', page=registros.next_num, 
                chave_acesso=request.args.get('chave_acesso'), 
                nota_fiscal=request.args.get('nota_fiscal'), 
                filial=request.args.get('filial'), 
                centro=request.args.get('centro'), 
                status=request.args.get('status'), 
                prioridade=request.args.get('prioridade'), 
                responsavel=request.args.get('responsavel')) }}">Próxima</a></li>
            {% endif %}
        </ul>
    </nav>

</section>
{% endblock %}
